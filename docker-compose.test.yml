# Testing Environment
# Usage: docker-compose -f docker-compose.test.yml up
#
# This configuration provides:
# - PostgreSQL database on port 5544
# - Valkey (Redis) on port 6481  
# - Guard API on port 8081 with test settings
# - MailHog for email testing
# - SDK conformance testing
# - Isolated test environment

services:
  db_test:
    image: postgres:17
    container_name: guard_test_postgres
    environment:
      POSTGRES_USER: guard
      POSTGRES_PASSWORD: guard
      POSTGRES_DB: guard_test
    ports:
      - "5544:5432"
    volumes:
      - guard_test_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U guard"]
      interval: 5s
      timeout: 5s
      retries: 10

  valkey_test:
    image: valkey/valkey:7.2
    container_name: guard_test_valkey
    ports:
      - "6481:6379"
    volumes:
      - guard_test_valkey_data:/data
    healthcheck:
      test: ["CMD-SHELL", "valkey-cli ping"]
      interval: 5s
      timeout: 5s
      retries: 10

  mailhog_test:
    image: mailhog/mailhog:latest
    container_name: guard_test_mailhog
    ports:
      - "1026:1025"   # SMTP (different port to avoid conflicts)
      - "8026:8025"   # Web UI at http://localhost:8026

  api_test:
    image: golang:1.24
    container_name: guard_test_api
    working_dir: /app
    command: sh -c "go mod download && go run ./cmd/api"
    environment:
      GOTOOLCHAIN: auto
      APP_ENV: test
      APP_ADDR: ":8080"
      DATABASE_URL: "postgres://guard:guard@db_test:5432/guard_test?sslmode=disable"
      REDIS_ADDR: "valkey_test:6379"
      REDIS_DB: 0
      JWT_SIGNING_KEY: "test-secret-change-me"
      RATELIMIT_DEBUG: "1"
      # Email via MailHog for test flows
      EMAIL_PROVIDER: "smtp"
      SMTP_HOST: "mailhog_test"
      SMTP_PORT: 1025
      SMTP_FROM: "no-reply@test.local"
      # Allow UI test origins
      CORS_ALLOWED_ORIGINS: "http://localhost:4173,http://localhost:3000"
    volumes:
      - ./:/app
      - /app/node_modules  # Prevent overwriting node_modules
    ports:
      - "8081:8080"   # Host API at http://localhost:8081
    depends_on:
      db_test:
        condition: service_healthy
      valkey_test:
        condition: service_healthy
      mailhog_test:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/readyz || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # SDK Conformance Testing (Optional - use profile to enable)
  sdk_conformance:
    image: node:20-alpine
    container_name: guard_test_sdk_conformance
    profiles: ["conformance"]
    working_dir: /app/sdk/ts
    command: ["/bin/sh", "-lc", "npm ci && npm run build && npm test && npm run conformance"]
    environment:
      BASE_URL: http://api_test:8080
      TENANT_ID: ""
      EMAIL: ""
      PASSWORD: ""
      TOTP_SECRET: ""
      AUTO_MAGIC_TOKEN: "true"
    volumes:
      - ./:/app
      - ./.npm-cache:/root/.npm
    depends_on:
      api_test:
        condition: service_healthy

  # Load Testing (Optional - use profile to enable)
  k6_test:
    image: grafana/k6:latest
    container_name: guard_test_k6
    profiles: ["load-test"]
    entrypoint: ["/bin/sh", "-lc"]
    command: ["k6 run /scripts/login_stress.js"]
    environment:
      K6_BASE_URL: http://api_test:8080
      K6_TENANT_ID: ""
      K6_EMAIL: ""
      K6_PASSWORD: ""
    volumes:
      - ./ops/k6:/scripts:ro
    depends_on:
      api_test:
        condition: service_healthy

volumes:
  guard_test_db_data:
  guard_test_valkey_data:
